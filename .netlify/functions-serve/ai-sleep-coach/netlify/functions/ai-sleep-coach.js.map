{
  "version": 3,
  "sources": ["../../../../../rxgibsmt/Dev/NexusLite/nexus-lite/netlify/functions/ai-sleep-coach.js", "../../../../../rxgibsmt/Dev/NexusLite/nexus-lite/netlify/functions/_util.js"],
  "sourceRoot": "C:/Users/rxgib/AppData/Local/Temp/tmp-7456-IFRcEw8TcBXU",
  "sourcesContent": ["// netlify/functions/ai-sleep-coach.js\r\nimport { withTimeout, callOpenAI, readJson } from \"./_util.js\";\r\n\r\nexport async function handler(event) {\r\n  try {\r\n    const { message, context } = await readJson(event);\r\n    const system = [\r\n      \"You are an empathetic, evidence-based sleep coach.\",\r\n      \"Give concise, practical guidance. Avoid medical diagnosis; suggest seeing a clinician when appropriate.\",\r\n      \"Reference provided user context (sleep trends, last night, environment) to personalize advice.\",\r\n      \"Use short bullets and numbered steps for longer replies.\"\r\n    ].join(\" \");\r\n\r\n    const user = `User message:\\n${message || \"\"}\\n\\nContext (JSON, optional):\\n${JSON.stringify(context || {})}`;\r\n\r\n    const result = await withTimeout(20000, (signal) =>\r\n      callOpenAI({ system, user, temperature: 0.4 }, signal)\r\n    );\r\n\r\n    return {\r\n      statusCode: result.status,\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify(result.json)\r\n    };\r\n  } catch (e) {\r\n    const isAbort = e?.name === \"AbortError\";\r\n    return {\r\n      statusCode: isAbort ? 504 : 500,\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ error: isAbort ? \"timeout\" : \"server_error\", detail: String(e) })\r\n    };\r\n  }\r\n}\r\n", "// netlify/functions/_util.js\r\n// Shared helpers for all AI functions\r\n\r\nexport async function withTimeout(ms, run) {\r\n  const ctrl = new AbortController();\r\n  const t = setTimeout(() => ctrl.abort(), ms);\r\n  try {\r\n    return await run(ctrl.signal);\r\n  } finally {\r\n    clearTimeout(t);\r\n  }\r\n}\r\n\r\n// Standard OpenAI call (Chat Completions)\r\nexport async function callOpenAI(\r\n  { system, user, temperature = 0.35, model = \"gpt-4o-mini\" },\r\n  signal\r\n) {\r\n  const key = process.env.OPENAI_API_KEY || \"\";\r\n  if (!key) {\r\n    return {\r\n      ok: false,\r\n      status: 500,\r\n      json: { error: \"missing_api_key\", detail: \"Set OPENAI_API_KEY in Netlify env vars.\" }\r\n    };\r\n  }\r\n\r\n  const resp = await fetch(\"https://api.openai.com/v1/chat/completions\", {\r\n    method: \"POST\",\r\n    headers: { \"Content-Type\": \"application/json\", Authorization: `Bearer ${key}` },\r\n    body: JSON.stringify({\r\n      model,\r\n      temperature,\r\n      messages: [\r\n        { role: \"system\", content: system },\r\n        { role: \"user\", content: user }\r\n      ]\r\n    }),\r\n    signal\r\n  });\r\n\r\n  if (!resp.ok) {\r\n    const text = await resp.text().catch(() => \"\");\r\n    return { ok: false, status: 502, json: { error: \"openai_error\", status: resp.status, detail: text } };\r\n  }\r\n\r\n  const data = await resp.json();\r\n  const content = data?.choices?.[0]?.message?.content || \"No reply.\";\r\n  return { ok: true, status: 200, json: { reply: content } };\r\n}\r\n\r\n// Simple JSON body reader (since we\u2019re on Netlify functions)\r\nexport async function readJson(event) {\r\n  try {\r\n    return JSON.parse(event.body || \"{}\");\r\n  } catch {\r\n    return {};\r\n  }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACGA,eAAsB,YAAY,IAAI,KAAK;AACzC,QAAM,OAAO,IAAI,gBAAgB;AACjC,QAAM,IAAI,WAAW,MAAM,KAAK,MAAM,GAAG,EAAE;AAC3C,MAAI;AACF,WAAO,MAAM,IAAI,KAAK,MAAM;AAAA,EAC9B,UAAE;AACA,iBAAa,CAAC;AAAA,EAChB;AACF;AAGA,eAAsB,WACpB,EAAE,QAAQ,MAAM,cAAc,MAAM,QAAQ,cAAc,GAC1D,QACA;AACA,QAAM,MAAM,QAAQ,IAAI,kBAAkB;AAC1C,MAAI,CAAC,KAAK;AACR,WAAO;AAAA,MACL,IAAI;AAAA,MACJ,QAAQ;AAAA,MACR,MAAM,EAAE,OAAO,mBAAmB,QAAQ,0CAA0C;AAAA,IACtF;AAAA,EACF;AAEA,QAAM,OAAO,MAAM,MAAM,8CAA8C;AAAA,IACrE,QAAQ;AAAA,IACR,SAAS,EAAE,gBAAgB,oBAAoB,eAAe,UAAU,GAAG,GAAG;AAAA,IAC9E,MAAM,KAAK,UAAU;AAAA,MACnB;AAAA,MACA;AAAA,MACA,UAAU;AAAA,QACR,EAAE,MAAM,UAAU,SAAS,OAAO;AAAA,QAClC,EAAE,MAAM,QAAQ,SAAS,KAAK;AAAA,MAChC;AAAA,IACF,CAAC;AAAA,IACD;AAAA,EACF,CAAC;AAED,MAAI,CAAC,KAAK,IAAI;AACZ,UAAM,OAAO,MAAM,KAAK,KAAK,EAAE,MAAM,MAAM,EAAE;AAC7C,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,MAAM,EAAE,OAAO,gBAAgB,QAAQ,KAAK,QAAQ,QAAQ,KAAK,EAAE;AAAA,EACtG;AAEA,QAAM,OAAO,MAAM,KAAK,KAAK;AAC7B,QAAM,UAAU,MAAM,UAAU,CAAC,GAAG,SAAS,WAAW;AACxD,SAAO,EAAE,IAAI,MAAM,QAAQ,KAAK,MAAM,EAAE,OAAO,QAAQ,EAAE;AAC3D;AAGA,eAAsB,SAAS,OAAO;AACpC,MAAI;AACF,WAAO,KAAK,MAAM,MAAM,QAAQ,IAAI;AAAA,EACtC,QAAQ;AACN,WAAO,CAAC;AAAA,EACV;AACF;;;ADvDA,eAAsB,QAAQ,OAAO;AACnC,MAAI;AACF,UAAM,EAAE,SAAS,QAAQ,IAAI,MAAM,SAAS,KAAK;AACjD,UAAM,SAAS;AAAA,MACb;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF,EAAE,KAAK,GAAG;AAEV,UAAM,OAAO;AAAA,EAAkB,WAAW,EAAE;AAAA;AAAA;AAAA,EAAkC,KAAK,UAAU,WAAW,CAAC,CAAC,CAAC;AAE3G,UAAM,SAAS,MAAM;AAAA,MAAY;AAAA,MAAO,CAAC,WACvC,WAAW,EAAE,QAAQ,MAAM,aAAa,IAAI,GAAG,MAAM;AAAA,IACvD;AAEA,WAAO;AAAA,MACL,YAAY,OAAO;AAAA,MACnB,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAC9C,MAAM,KAAK,UAAU,OAAO,IAAI;AAAA,IAClC;AAAA,EACF,SAAS,GAAG;AACV,UAAM,UAAU,GAAG,SAAS;AAC5B,WAAO;AAAA,MACL,YAAY,UAAU,MAAM;AAAA,MAC5B,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAC9C,MAAM,KAAK,UAAU,EAAE,OAAO,UAAU,YAAY,gBAAgB,QAAQ,OAAO,CAAC,EAAE,CAAC;AAAA,IACzF;AAAA,EACF;AACF;",
  "names": []
}
